
## Fixed Parameters
BIAS_PERIOD='1900/1950'
GAM_DOF=7
GAM_DEGREE=3

## Path
for p in $HPATH/LOG $DPATH/FIT $DPATH/SYNTHESIS $DPATH/ANALYSIS $DPATH/CONSTRAIN $DPATH/FIGURES
do
    if [[ ! -d $p ]]
    then
	    mkdir $p
	fi
done

## Some parameters
DPERS='ssp126,ssp245,ssp370,ssp585'

## Find the model list
MODELS=$(ls $DPATH/INPUT/X-GMST)

## Loop on models to fit the statistical model
echo "Loop on models"
for MODNC in $MODELS
do
    MOD=$(basename $MODNC .nc)
    echo " * $MOD"
    echo "   => fit X"
    bsac fit X --n-samples $N_SAMPLES -v --log-file $HPATH/LOG/'FITX_'$MOD.log\
               --bias-period $BIAS_PERIOD\
               --input GMST,$DPATH/INPUT/X-GMST/$MODNC EU,$DPATH/INPUT/X-EU/$MODNC\
               --save-clim $DPATH/FIT/$MOD'_fitX.nc'\
               --common-period historical --different-periods $DPERS\
               --config GAM_dof=$GAM_DOF,GAM_degree=$GAM_DEGREE\
               --total-memory $TOTAL_MEMORY\
               --n-workers $N_WORKERS\
               --threads-per-worker $THREADS_PER_WORKER
	
    echo "   => show X"
    bsac show X --n-samples $N_SAMPLES -v --log-file $HPATH/LOG/'SHOWX_'$MOD.log\
                --bias-period $BIAS_PERIOD\
                --load-clim $DPATH/FIT/$MOD'_fitX.nc'\
                --input GMST,$DPATH/INPUT/X-GMST/$MODNC EU,$DPATH/INPUT/X-EU/$MODNC\
                --output $DPATH/FIGURES/BSAC_SHOW_X_$MOD.pdf\
                --total-memory $TOTAL_MEMORY\
                --n-workers $N_WORKERS\
                --threads-per-worker $THREADS_PER_WORKER
	
done

## Run synthesis
echo " * synthesis"
bsac synthesize -v --log-file $HPATH/LOG/SYNTHESIS.log\
                --bias-period $BIAS_PERIOD\
                --input $DPATH/FIT/*_fitY.nc\
                --common-period historical --different-periods $DPERS\
                --config nslaw=Normal,GAM_dof=$GAM_DOF,GAM_degree=$GAM_DEGREE,names=GMST:EU:tas\
                --save-clim $DPATH/SYNTHESIS/SYNTHESIS.nc\
                --total-memory $TOTAL_MEMORY\
                --n-workers $N_WORKERS\
                --threads-per-worker $THREADS_PER_WORKER

echo " * show X of synthesis"
bsac show X --n-samples $N_SAMPLES -v --log-file $HPATH/LOG/SHOWX_SYNTHESIS.log\
            --bias-period $BIAS_PERIOD\
            --load-clim $DPATH/SYNTHESIS/SYNTHESIS.nc\
            --output $DPATH/FIGURES/BSAC_SHOW_X_SYNTHESIS.pdf\
            --total-memory $TOTAL_MEMORY\
            --n-workers $N_WORKERS\
            --threads-per-worker $THREADS_PER_WORKER

## Run constraint
echo " * constraint X of observations"
bsac constrain X -v --log-file $HPATH/LOG/CONSTRAINX.log --use-KCC\
                 --bias-period $BIAS_PERIOD\
                 --load-clim $DPATH/SYNTHESIS/SYNTHESIS.nc\
                 --save-clim $DPATH/CONSTRAIN/CONSTRAINX.nc\
                 --input GMST,$DPATH/INPUT/Xo/GMST_GISTEMP_tas_year_1880-2024.nc EU,$DPATH/INPUT/Xo/EU_HadCRUT_tas_year_1850-2024.nc\
                 --total-memory $TOTAL_MEMORY\
                 --n-workers $N_WORKERS\
                 --threads-per-worker $THREADS_PER_WORKER

echo " * show X of constraint"
bsac show X --n-samples $N_SAMPLES -v --log-file $HPATH/LOG/SHOWX_CONSTRAINX.log\
            --bias-period $BIAS_PERIOD\
            --load-clim $DPATH/CONSTRAIN/CONSTRAINX.nc\
            --input $DPATH/INPUT/GMST/Xo/GISTEMP_tas_year_1880-2024.nc\
            --output $DPATH/FIGURES/BSAC_SHOW_X_CONSTRAINX.pdf\
            --total-memory $TOTAL_MEMORY\
            --n-workers $N_WORKERS\
            --threads-per-worker $THREADS_PER_WORKER

echo " * show X of constraint VS synthesis"
bsac show CX --n-samples $N_SAMPLES -v --log-file $HPATH/LOG/SHOWCX_CONSTRAINX-VS-SYNTHESIS.log\
             --bias-period $BIAS_PERIOD\
             --load-clim $DPATH/CONSTRAIN/CONSTRAINX.nc\
             --input $DPATH/SYNTHESIS/SYNTHESIS.nc\
             --output $DPATH/FIGURES/BSAC_SHOW_CX_CONSTRAINX-VS-SYNTHESIS.pdf\
             --total-memory $TOTAL_MEMORY\
             --n-workers $N_WORKERS\
             --threads-per-worker $THREADS_PER_WORKER

## END OF SCRIPT
